---
- name: Clone the repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ app_path }}"
    version: main
    force: yes

- name: Build step
  command: npm install
  args:
    chdir: "{{ app_path }}/server"

- name: Pull server image
  community.docker.docker_image:
    name: therealpad/my-node-app
    source: pull

- name: Build image and with build args
  community.docker.docker_image:
    name: "{{ app_name }}"
    build:
      path: "{{ app_path }}/server"
    source: build

- name: Run Node.js container
  community.docker.docker_container:
    name: my-node-app
    image: "{{ app_name }}"
    state: started
    restart_policy: always
    ports:
      - "3000:3000"
    env:
      PORT: "3000"
      USERNAME: "{{ node_username }}"
      PASSWORD: "{{ node_password }}"
      SECRET_MESSAGE: "{{ secret_message }}"
